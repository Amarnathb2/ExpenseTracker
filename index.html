<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expense Tracker</title>
<style>
body { font-family: Arial; margin:20px; text-align:center; }
form, table { margin:20px auto; max-width:90%; border-collapse: collapse; }
input, select, button { padding:8px; border-radius:6px; border:1px solid #cbd5e0; margin:5px; }
button { background:#2b6cb0; color:white; cursor:pointer; }
button:hover { background:#2c5282; }
th, td { border:1px solid #cbd5e0; padding:8px; text-align:center; }
th { background:#2b6cb0; color:white; }
</style>
</head>
<body>

<h2>Expense Tracker</h2>

<!-- Sign-in Button -->
<div id="signinDiv">
  <div id="g_id_onload"
       data-client_id="257055116652-3fidtne77h0ga05efu2e85q1r1pn1qoa.apps.googleusercontent.com"
       data-login_uri=""
       data-ux_mode="popup"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false">
  </div>
  <div class="g_id_signin" data-type="standard"></div>
</div>

<!-- Dashboard -->
<div id="dashboard" style="display:none;">
  <h3>Add Expense</h3>
  <form id="expenseForm">
    <label>Item:</label>
    <input type="text" id="itemName" required>

    <label>Expense Type:</label>
    <select id="expenseType">
      <option value="Grocery">Grocery</option>
      <option value="Food">Food</option>
      <option value="Travel">Travel</option>
      <option value="EMI">EMI</option>
      <option value="Other">Other</option>
    </select>

    <div id="emiDiv" style="display:none;">
      <label>EMI Type:</label>
      <select id="emiType"></select>
      <input type="text" id="newEMIType" placeholder="Configure new EMI">
      <input type="number" id="totalEMI" placeholder="Total EMI Amount">
    </div>

    <label>Amount:</label>
    <input type="number" id="amount" required>
    <button type="submit">Add Expense</button>
  </form>

  <h3>Expenses</h3>
  <div id="expensesContainer"></div>

  <h3>Total Spent: <span id="totalSpent">0</span></h3>
  <button onclick="generateReport()">Generate Excel Report</button>
  <button onclick="saveToDrive()">Save to Google Drive</button>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
let accessToken = null;
let expensesData = { expenses: [], emiTypes: [] };

// ---------------- Google Identity callback ----------------
function handleCredentialResponse(response){
  // Decode JWT to get user's info
  const data = parseJwt(response.credential);
  console.log("Signed in as:", data.email);
  // Use OAuth 2.0 token for Drive API
  accessToken = response.credential;
  document.getElementById('signinDiv').style.display='none';
  document.getElementById('dashboard').style.display='block';
  loadFromDrive();
}

function parseJwt(token) {
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  return JSON.parse(decodeURIComponent(atob(base64).split('').map(c=> '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')));
}

// ---------------- Expense Form ----------------
const expenseType = document.getElementById('expenseType');
const emiDiv = document.getElementById('emiDiv');
const emiSelect = document.getElementById('emiType');

expenseType.addEventListener('change', e=>{
  emiDiv.style.display = e.target.value==='EMI' ? 'block':'none';
  populateEMItypes();
});

function populateEMItypes(){
  emiSelect.innerHTML = '';
  expensesData.emiTypes.forEach(e=>{
    const opt = document.createElement('option');
    opt.value=e.name; opt.textContent=e.name;
    emiSelect.appendChild(opt);
  });
}

document.getElementById('expenseForm').addEventListener('submit', e=>{
  e.preventDefault();
  const type = expenseType.value;
  const itemName = document.getElementById('itemName').value;
  const amount = parseFloat(document.getElementById('amount').value);
  let emiType = null;

  if(type==='EMI'){
    emiType = document.getElementById('newEMIType').value || emiSelect.value;
    const totalAmount = parseFloat(document.getElementById('totalEMI').value) || amount;
    let emi = expensesData.emiTypes.find(e=>e.name===emiType);
    if(!emi){
      expensesData.emiTypes.push({name: emiType, totalAmount, paidAmount: 0});
    }
  }

  expensesData.expenses.push({type,itemName,amount,emiType,date:new Date(),paidAmount:type==='EMI'?amount:0,remainingAmount:type==='EMI'?amount:0});
  saveData();
  displayExpenses();
  document.getElementById('expenseForm').reset();
  emiDiv.style.display='none';
});

// ---------------- Display Expenses ----------------
function displayExpenses(){
  const container = document.getElementById('expensesContainer');
  if(expensesData.expenses.length===0){
      container.innerHTML="<p>No expenses yet.</p>";
      document.getElementById('totalSpent').textContent=0;
      return;
  }

  let total=0;
  let html='<h4>Other Expenses</h4><table><tr><th>Item</th><th>Type</th><th>Amount</th><th>Date</th></tr>';
  expensesData.expenses.filter(e=>e.type!=='EMI').forEach(e=>{
      html+=`<tr><td>${e.itemName}</td><td>${e.type}</td><td>${e.amount}</td><td>${new Date(e.date).toLocaleString()}</td></tr>`;
      total+=e.amount;
  });
  html+='</table>';

  html+='<h4>EMI Expenses</h4><table><tr><th>Item</th><th>EMI Type</th><th>Paid</th><th>Remaining</th><th>Date</th></tr>';
  expensesData.expenses.filter(e=>e.type==='EMI').forEach(e=>{
      html+=`<tr><td>${e.itemName}</td><td>${e.emiType}</td><td>${e.paidAmount}</td><td>${e.remainingAmount}</td><td>${new Date(e.date).toLocaleString()}</td></tr>`;
      total+=e.paidAmount;
  });
  html+='</table>';

  container.innerHTML = html;
  document.getElementById('totalSpent').textContent = total;
}

// ---------------- LocalStorage ----------------
function saveData(){ localStorage.setItem('expensesData',JSON.stringify(expensesData)); }
window.addEventListener('load',()=>{
  const localData = localStorage.getItem('expensesData');
  if(localData){ expensesData=JSON.parse(localData); displayExpenses(); populateEMItypes(); }
});

// ---------------- Excel Report ----------------
function generateReport(){
  const wb=XLSX.utils.book_new();
  const wsData=[['Item','Type','EMI Type','Paid','Remaining','Date']];
  expensesData.expenses.forEach(e=>{ wsData.push([e.itemName,e.type,e.emiType||'',e.paidAmount||'',e.remainingAmount||'',new Date(e.date).toLocaleString()]); });
  const ws=XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb,ws,"Expenses");
  XLSX.writeFile(wb,"ExpenseReport.xlsx");
}

// ---------------- Google Drive ----------------
function loadFromDrive(){
  if(!accessToken) return;
  gapi.load('client', ()=>{
    gapi.client.init({apiKey:'AIzaSyBgaRAcjeS2xwuM-AZve28NHaOC_Iy_tXo', discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]})
    .then(()=> gapi.client.request({path:'/drive/v3/files', method:'GET', params:{q:'name="ExpenseTrackerData.json"', fields:'files(id,name)'}}))
    .then(res=>{
      if(res.result.files.length>0){
        const fileId=res.result.files[0].id;
        gapi.client.request({path:'/drive/v3/files/'+fileId, method:'GET', params:{alt:'media'}})
        .then(r=>{
          expensesData=r.result;
          saveData(); displayExpenses(); populateEMItypes();
        });
      }
    });
  });
}

function saveToDrive(){
  if(!accessToken) return alert('Not signed in');
  const metadata = {name:"ExpenseTrackerData.json", mimeType:"application/json"};
  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(metadata)], {type:"application/json"}));
  form.append("file", new Blob([JSON.stringify(expensesData)], {type:"application/json"}));
  fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
    method:"POST",
    headers:{Authorization:"Bearer "+accessToken},
    body:form
  }).then(r=>r.ok?alert("Saved to Drive!"):alert("Failed!"));
}
</script>

</body>
</html>
