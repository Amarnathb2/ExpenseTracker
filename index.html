<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expense Tracker</title>
<style>
body { font-family: Arial; margin:20px; text-align:center; }
form, table { margin:20px auto; max-width:90%; border-collapse: collapse; }
input, select, button { padding:8px; border-radius:6px; border:1px solid #cbd5e0; margin:5px; }
button { background:#2b6cb0; color:white; cursor:pointer; }
button:hover { background:#2c5282; }
th, td { border:1px solid #cbd5e0; padding:8px; text-align:center; }
th { background:#2b6cb0; color:white; }
</style>
</head>
<body>

<h2>Expense Tracker</h2>

<div id="signinDiv">
  <button onclick="handleSignIn()">Sign in with Google</button>
</div>

<div id="dashboard" style="display:none;">
  <h3>Add Expense</h3>
  <form id="expenseForm">
    <label>Item:</label>
    <input type="text" id="itemName" required>

    <label>Expense Type:</label>
    <select id="expenseType">
      <option value="Grocery">Grocery</option>
      <option value="Food">Food</option>
      <option value="Travel">Travel</option>
      <option value="EMI">EMI</option>
      <option value="Other">Other</option>
    </select>

    <div id="emiDiv" style="display:none;">
      <label>EMI Type:</label>
      <select id="emiType"></select>
      <input type="text" id="newEMIType" placeholder="Configure new EMI">
      <input type="number" id="totalEMI" placeholder="Total EMI Amount">
    </div>

    <label>Amount:</label>
    <input type="number" id="amount" required>
    <button type="submit">Add Expense</button>
  </form>

  <h3>Expenses</h3>
  <div id="expensesContainer"></div>

  <h3>Total Spent: <span id="totalSpent">0</span></h3>
  <button onclick="generateReport()">Generate Excel Report</button>
  <button onclick="saveToDrive()">Save to Google Drive</button>
</div>

<script src="https://apis.google.com/js/api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
// ---------------- Config ----------------
const CLIENT_ID = '257055116652-3fidtne77h0ga05efu2e85q1r1pn1qoa.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBgaRAcjeS2xwuM-AZve28NHaOC_Iy_tXo';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let accessToken = null;
let expensesData = { expenses: [], emiTypes: [] };

// ---------------- Google OAuth ----------------
function handleSignIn(){
  gapi.load('client:auth2', initClient);
}

function initClient(){
  gapi.client.init({
    apiKey: API_KEY,
    clientId: CLIENT_ID,
    scope: SCOPES,
    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
  }).then(()=>{
    gapi.auth2.getAuthInstance().signIn().then(()=>{
      accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
      document.getElementById('signinDiv').style.display='none';
      document.getElementById('dashboard').style.display='block';
      loadFromDrive();
    });
  });
}

// ---------------- Expense Form ----------------
const expenseType = document.getElementById('expenseType');
const emiDiv = document.getElementById('emiDiv');
const emiSelect = document.getElementById('emiType');

expenseType.addEventListener('change', e=>{
  emiDiv.style.display = e.target.value==='EMI' ? 'block':'none';
  populateEMItypes();
});

function populateEMItypes(){
  emiSelect.innerHTML = '';
  expensesData.emiTypes.forEach(e=>{
    const opt = document.createElement('option');
    opt.value = e.name; opt.textContent=e.name;
    emiSelect.appendChild(opt);
  });
}

document.getElementById('expenseForm').addEventListener('submit', e=>{
  e.preventDefault();
  const type = expenseType.value;
  const itemName = document.getElementById('itemName').value;
  const amount = parseFloat(document.getElementById('amount').value);
  let emiType = null;

  if(type==='EMI'){
    emiType = document.getElementById('newEMIType').value || emiSelect.value;
    const totalAmount = parseFloat(document.getElementById('totalEMI').value) || amount;
    let emi = expensesData.emiTypes.find(e=>e.name===emiType);
    if(!emi){
      expensesData.emiTypes.push({name: emiType, totalAmount, paidAmount: 0});
    }
  }

  expensesData.expenses.push({type, itemName, amount, emiType, date:new Date(), paidAmount:type==='EMI'?amount:0, remainingAmount:type==='EMI'?amount:0});
  saveData();
  displayExpenses();
  document.getElementById('expenseForm').reset();
  emiDiv.style.display='none';
});

// ---------------- Display Expenses ----------------
function displayExpenses(){
  const container = document.getElementById('expensesContainer');
  if(expensesData.expenses.length===0){
      container.innerHTML = "<p>No expenses yet.</p>";
      document.getElementById('totalSpent').textContent=0;
      return;
  }

  let total=0;
  let html = '<h4>Other Expenses</h4><table><tr><th>Item</th><th>Type</th><th>Amount</th><th>Date</th></tr>';
  expensesData.expenses.filter(e=>e.type!=='EMI').forEach(e=>{
      html+=`<tr><td>${e.itemName}</td><td>${e.type}</td><td>${e.amount}</td><td>${new Date(e.date).toLocaleString()}</td></tr>`;
      total+=e.amount;
  });
  html+='</table>';

  html+='<h4>EMI Expenses</h4><table><tr><th>Item</th><th>EMI Type</th><th>Paid</th><th>Remaining</th><th>Date</th></tr>';
  expensesData.expenses.filter(e=>e.type==='EMI').forEach(e=>{
      html+=`<tr><td>${e.itemName}</td><td>${e.emiType}</td><td>${e.paidAmount}</td><td>${e.remainingAmount}</td><td>${new Date(e.date).toLocaleString()}</td></tr>`;
      total+=e.paidAmount;
  });
  html+='</table>';

  container.innerHTML = html;
  document.getElementById('totalSpent').textContent = total;
}

// ---------------- LocalStorage ----------------
function saveData(){ localStorage.setItem('expensesData', JSON.stringify(expensesData)); }

window.addEventListener('load',()=>{
  const localData = localStorage.getItem('expensesData');
  if(localData){ expensesData = JSON.parse(localData); displayExpenses(); populateEMItypes(); }
});

// ---------------- Generate Excel ----------------
function generateReport(){
  const wb = XLSX.utils.book_new();
  const wsData = [['Item','Type','EMI Type','Paid','Remaining','Date']];
  expensesData.expenses.forEach(e=>{
    wsData.push([e.itemName,e.type,e.emiType||'',e.paidAmount||'',e.remainingAmount||'',new Date(e.date).toLocaleString()]);
  });
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Expenses");
  XLSX.writeFile(wb,"ExpenseReport.xlsx");
}

// ---------------- Google Drive ----------------
function loadFromDrive(){
  if(!accessToken) return;
  gapi.client.drive.files.list({
      q: 'name="ExpenseTrackerData.json"',
      fields: "files(id,name)"
  }).then(res=>{
      if(res.result.files.length>0){
          const fileId = res.result.files[0].id;
          gapi.client.drive.files.get({fileId:fileId, alt:'media'}).then(r=>{
              expensesData = r.result;
              saveData();
              displayExpenses();
              populateEMItypes();
          });
      }
  });
}

function saveToDrive(){
  if(!accessToken) return alert('Sign in first!');
  gapi.client.drive.files.list({
    q: 'name="ExpenseTrackerData.json"',
    fields: "files(id,name)"
  }).then(res=>{
    let fileId = res.result.files.length>0 ? res.result.files[0].id : null;
    const request = fileId ? gapi.client.request({
      path: '/upload/drive/v3/files/'+fileId,
      method: 'PATCH',
      params: {uploadType:'media'},
      body: JSON.stringify(expensesData),
      headers:{'Content-Type':'application/json'}
    }) : gapi.client.request({
      path: '/upload/drive/v3/files',
      method: 'POST',
      params: {uploadType:'media'},
      body: JSON.stringify(expensesData),
      headers:{'Content-Type':'application/json'}
    });
    request.then(()=>alert('Saved to Drive!'), err=>console.error(err));
  });
}
</script>
</body>
</html>
